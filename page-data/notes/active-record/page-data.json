{"componentChunkName":"component---src-templates-note-template-js","path":"/notes/active-record","result":{"data":{"markdownRemark":{"id":"9001757c-0c7c-5a37-a58e-be06b5968b61","html":"<h2 id=\"includes\" style=\"position:relative;\"><a href=\"#includes\" aria-label=\"includes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>includes</h2>\n<ul>\n<li>\n<p><a href=\"https://engineering.gusto.com/a-visual-guide-to-using-includes-in-rails/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Read</a></p>\n<h3 id=\"how-to-use-includes\" style=\"position:relative;\"><a href=\"#how-to-use-includes\" aria-label=\"how to use includes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to use includes</h3>\n</li>\n<li>\n<p>Join</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">Users</span><span class=\"token punctuation\">.</span>includes<span class=\"token punctuation\">(</span><span class=\"token symbol\">:contanct_info</span><span class=\"token punctuation\">)</span>`</code></pre></div>\n</li>\n<li>\n<p>Apply where condition to associated models. The <code class=\"language-text\">references</code> is required to access associated models</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">Users</span><span class=\"token punctuation\">.</span>includes<span class=\"token punctuation\">(</span><span class=\"token symbol\">:contanct_info</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">(</span><span class=\"token string\">\"contact_infos.city = 'San Diego'\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span>references<span class=\"token punctuation\">(</span><span class=\"token symbol\">:contanct_info</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>\n<p>Nested Join</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">User</span><span class=\"token punctuation\">.</span>includes<span class=\"token punctuation\">(</span>contact_info<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token symbol\">:email</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ul>\n<h3 id=\"preload-vs-eager_load\" style=\"position:relative;\"><a href=\"#preload-vs-eager_load\" aria-label=\"preload vs eager_load permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>preload v.s eager_load</h3>\n<ul>\n<li>\n<p>Default using <code class=\"language-text\">preload</code>, which will load leading model and associated model based on the foreign key</p>\n<p><code class=\"language-text\">Users.includes(:contanct_info)</code> will load <strong>all users</strong> and <strong>contanct_infos which has foreign key in users</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">SELECT</span> users<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token constant\">FROM</span> users\n<span class=\"token constant\">SELECT</span> contact_infos<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token constant\">FROM</span> contact_infos <span class=\"token constant\">WHERE</span> contact_infos<span class=\"token punctuation\">.</span>id <span class=\"token constant\">IN</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>\n<p>When using <code class=\"language-text\">includes</code> with <code class=\"language-text\">where</code> or <code class=\"language-text\">references</code>, it will use <code class=\"language-text\">eager_load</code> and load both <strong>whole users and contanct_infos</strong> instead. <code class=\"language-text\">eager_load</code> use <strong>Left Join</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">Users</span><span class=\"token punctuation\">.</span>includes<span class=\"token punctuation\">(</span><span class=\"token symbol\">:contanct_info</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">(</span><span class=\"token string\">\"contact_infos.city = 'San Diego'\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span>references<span class=\"token punctuation\">(</span><span class=\"token symbol\">:contanct_info</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>The data shows that using <code class=\"language-text\">:includes</code> will improve the performance significantly when a <code class=\"language-text\">:preload</code> is invoked, but has the opposite effect for <code class=\"language-text\">:eager_load</code> in most cases</li>\n</ul>\n<hr>\n<h2 id=\"query-optimization\" style=\"position:relative;\"><a href=\"#query-optimization\" aria-label=\"query optimization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Query Optimization</h2>\n<h3 id=\"why-using-size-instead-of-count\" style=\"position:relative;\"><a href=\"#why-using-size-instead-of-count\" aria-label=\"why using size instead of count permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why using <code class=\"language-text\">size</code> instead of <code class=\"language-text\">count</code></h3>\n<ul>\n<li><code class=\"language-text\">count</code> on an ActiveRecord relation will always try to execute a SQL query</li>\n<li>\n<p><code class=\"language-text\">size</code> checks the length of ActiveRecord without making any SQL query</p>\n<p><strong>Only call COUNT when ActiveRecord is not loaded.</strong><br/>\nChange the order and replace count with size to make sure ActiveRecord is loaded beforehand</p>\n</li>\n<li>Use <code class=\"language-text\">load</code> to load directly (no lazy loading)<br/>\n<code class=\"language-text\">ActiveRecord::QueryCache</code> only happen when a query is called twice</li>\n</ul>\n<h3 id=\"when-to-use-where-and-when-not\" style=\"position:relative;\"><a href=\"#when-to-use-where-and-when-not\" aria-label=\"when to use where and when not permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>When to use <code class=\"language-text\">where</code> and when not??**</h3>\n<ul>\n<li>Don’t call <code class=\"language-text\">scopes</code> on associations when you’re rendering collections</li>\n<li>Don’t put query methods, like <code class=\"language-text\">where</code>, in instance methods of an <code class=\"language-text\">ActiveRecord::Base</code> class.</li>\n<li><code class=\"language-text\">includes</code> + <code class=\"language-text\">scopes</code> (and other preloading + association) is a way to reduce the cost of <code class=\"language-text\">where</code></li>\n<li><code class=\"language-text\">includes</code> use a concept called “Eager loading”, Eager loading works by preloading every comment for every article beforehand in a temporary cache stored in memory</li>\n<li>\n<p>When an Active Record associated is called, the association method will first try to pull the requested association data out of the <code class=\"language-text\">@association_cache</code> instance variable assuming it has already been loaded into memory.</p>\n<p><a href=\"https://www.speedshop.co/2019/01/10/three-activerecord-mistakes.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Three Active Record Mistake</a></p>\n<p><a href=\"https://medium.com/@bretdoucette/n-1-queries-and-how-to-avoid-them-a12f02345be5\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">What’s N+1 query</a></p>\n<p><a href=\"https://www.justinweiss.com/articles/how-to-preload-rails-scopes/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Preload scope to avoid make N+1 queries</a></p>\n</li>\n</ul>\n<h3 id=\"when-to-use-present-when-not\" style=\"position:relative;\"><a href=\"#when-to-use-present-when-not\" aria-label=\"when to use present when not permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>When to use present, when not??</h3>\n<ul>\n<li>\n<p><code class=\"language-text\">present?</code> actually call <code class=\"language-text\">!blank?</code><br/>\nEmptiness like <code class=\"language-text\">[] {} “”</code> then present is useful</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token punctuation\">[</span><span class=\"token number\">27</span><span class=\"token punctuation\">]</span> pry<span class=\"token punctuation\">(</span>main<span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">28</span><span class=\"token punctuation\">]</span> pry<span class=\"token punctuation\">(</span>main<span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>present<span class=\"token operator\">?</span>\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">false</span>\n\n<span class=\"token constant\">Otherwise</span><span class=\"token punctuation\">,</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token number\">33</span><span class=\"token punctuation\">]</span> pry<span class=\"token punctuation\">(</span>main<span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token number\">0</span>\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">34</span><span class=\"token punctuation\">]</span> pry<span class=\"token punctuation\">(</span>main<span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token number\">0.</span>present<span class=\"token operator\">?</span>\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">35</span><span class=\"token punctuation\">]</span> pry<span class=\"token punctuation\">(</span>main<span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token keyword\">nil</span>\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">36</span><span class=\"token punctuation\">]</span> pry<span class=\"token punctuation\">(</span>main<span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token keyword\">nil</span><span class=\"token punctuation\">.</span>present<span class=\"token operator\">?</span>\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">false</span></code></pre></div>\n</li>\n</ul>\n<h2 id=\"find_each-vs-alleach\" style=\"position:relative;\"><a href=\"#find_each-vs-alleach\" aria-label=\"find_each vs alleach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>find_each v.s all.each</h2>\n<ul>\n<li><code class=\"language-text\">find_each</code> use batch load which is good for memory while dealing with great amounts of data</li>\n</ul>","frontmatter":{"title":"Active Record","date":"2020-07-26","description":null,"socialImage":null}}},"pageContext":{"slug":"/notes/active-record"}},"staticQueryHashes":["251939775","401334301","4017299803","825871152"]}